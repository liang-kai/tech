# javascript å¯¹è±¡å±æ€§çš„æ“ä½œ

ECMA-262ç¬¬äº”ç‰ˆåœ¨å®šä¹‰åªæœ‰å†…éƒ¨æ‰ç”¨çš„ç‰¹æ€§çš„æ—¶å€™ï¼Œæè¿°äº†å±æ€§çš„å„ç§ç‰¹å¾ã€‚å®ç°è¿™äº›ç‰¹å¾æ˜¯ç»™ javascript å¼•æ“ç”¨çš„ï¼Œå› æ­¤äººä¸ºå¢åŠ äº†ä¸€äº›éš¾åº¦ï¼Œæ¯”å¦‚å±æ€§éƒ½ç”¨ä¸¤ä¸ªæ–¹æ‹¬å·å¥—èµ·æ¥ã€‚è€Œè¿™ç§å±æ€§ç±»å‹åœ¨éƒ¨åˆ†åœºæ™¯çš„äº‹ä»¶ä¸­å¯ä»¥å¸¦æ¥å¾ˆå¤§çš„ä¾¿åˆ©æ€§ï¼Œæ¯”å¦‚vueé‡Œçš„æ•°æ®ç»‘å®šã€‚èƒ½æ“ä½œå¥½å±æ€§ï¼Œåœ¨è®¾è®¡ä¸Šåˆå¤šäº†ä¸€å±‚æƒ³è±¡ç©ºé—´ã€‚

è®°å¾—ï¼Œæ•°ç»„ã€å‡½æ•°ï¼Œéƒ½æ˜¯å¯¹è±¡ï¼Œéƒ½æœ‰å±æ€§çš„å„ç§ç‰¹æ€§ã€‚åªæ˜¯å¹³æ—¶ç”¨ä¸ä¼šå¯¹æ•°ç»„è¿›é¡¹è¿™æ ·çš„æ“ä½œç½¢äº†ã€‚proxy çš„æ–¹æ³•å€’æ˜¯ç»™äº†å‡½æ•°ä¸€äº›æƒ³è±¡åŠ›ã€‚

```javascript
var person = {
  name : 'Nichoias',
  age : 27,
  job : 'Software Engineer',
  sayName(){
    alert(this.name)
  }
}

```
æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œå¼•ç”¨ç±»å‹å­˜å‚¨åœ¨å†…å­˜çš„å †ç©ºé—´ï¼Œå¦‚ä¸Š person å˜é‡æŒ‡å‘å †ç©ºé—´çš„æŸä¸ªåœ°å€ã€‚å…¶ä¸­çš„ name å±æ€§å½“åšç®€å•ç±»å‹çœ‹å¾…ï¼Ÿno!no!no! å¦‚æœè¿™æ ·æƒ³ï¼Œé‚£å°±æ˜¯æŠŠæ‰§è¡Œä¸Šä¸‹æ–‡çš„å˜é‡æ¦‚å¿µå’Œå¼•ç”¨ç±»å‹å­˜å–çš„æ¦‚å¿µææ··äº†ã€‚å¯¹è±¡å±æ€§çš„æ•°æ®å­˜å–ï¼Œæ›´åƒæ˜¯æœ‰ä¸ªä»£ç†äººåœ¨æ‰“ç†ï¼Œå°±åƒreduxé‡Œçš„reducerä¸€æ ·ï¼Œå†…éƒ¨å®šä¹‰äº†ä¸€å¥—é€»è¾‘ï¼Œåªèƒ½æ¥å—ç‰¹å®šçš„å‘½ä»¤ã€ä¸å¯ä»¥ä¹±æ¥ã€‚


## å±æ€§ç±»å‹

åˆ†ä¸ºæ•°æ®å±æ€§å’Œè®¿é—®å™¨å±æ€§

1. **æ•°æ®å±æ€§**ï¼Œå››ä¸ªæè¿°å…¶ç‰¹æ€§çš„å±æ€§æ˜¯ï¼š
  - `[[ Configurable ]]`  
    é»˜è®¤ *true*, å¦‚æœä¸ºfalseï¼Œåˆ™è¢«å†»ä½äº†ï¼Œæœ‰ä¸‰å±‚æ„æ€ï¼š  
    1. ä¸å¯ *delete* åˆ é™¤
    2. ä¸å¯ä¿®æ”¹å±æ€§ç‰¹æ€§ï¼ˆä¸€æ—¦è®¾ç½®ä¸º*false*,åˆ™å±æ€§å€¼å°±æ”¹ä¸äº†äº†ï¼Œç®€ç›´ä¸å¯é€†å•Šï¼Œå†·å†»å±æ€§åˆ©å™¨å•Šï¼‰
    3. ä¸èƒ½æŠŠå±æ€§å€¼ä¿®æ”¹ä¸ºè®¿é—®å™¨å±æ€§
  - `[[ Enumerable ]]` å¯å¦ä½¿ç”¨ *for...in...* æšä¸¾
  - `[[ Writable ]]` æ˜¯å¦å¯ä¿®æ”¹
  - `[[ Value ]]` çœŸæ­£çš„å€¼



2. è®¿é—®å™¨å±æ€§
  - `[[ Configurable ]]` ä¸ä¸Šé¢ç±»ä¼¼ï¼Œä¸è¿‡ä¸º*false*çš„ç¬¬ä¸‰ç‚¹éœ€è¦åè¿‡æ¥ï¼Œä¸èƒ½æ”¹ä¸ºæ•°æ®å±æ€§
  - `[[ Enumerable ]]` ä¸ä¸Šé¢ç›¸åŒ
  - `[[ Get ]]` è·å–å€¼
  - `[[ Set ]]` è®¾ç½®å€¼ï¼Œå¯æ¥å—æ–°å€¼ä½œä¸ºå‚æ•°

è¦æ”¹å˜å±æ€§å€¼ï¼Œå¯ä»¥ç”¨ *Object.defineProperty()* æ–¹æ³•,è¿™ä¹Ÿæ˜¯å®šä¹‰å•ä¸€å±æ€§çš„æ–¹å¼ï¼Œæ³¨æ„ä¼ å‚ã€‚ä½¿ç”¨äº†*Object*ä¸Šæ–¹æ³•ï¼Œè€Œä¸æ˜¯åŸå‹é“¾ä¸Šçš„ï¼Œè¯´æ˜ä¸æ˜¯è‡ªå®¶äººï¼Œè€Œæ˜¯äº²æˆšå®¶çš„ï¼Œè®¾è®¡è€…ç¡®å®æ²¡æƒ³è®©ä½ æ–¹ä¾¿åœ°æ“ä½œå¯¹è±¡å±æ€§ã€‚
```javascript
  var obj = {}
  Object.defineProperty(obj, 'name', {
    configurable: true,
    enumerable: true,
    value: 'wang'
    
  })

  var age = 3

  Object.defineProperty(obj, 'age', {
    get(){
      return age;
    },
    set(v){
      age = v + 1;
    }
  })
  obj.age = 1
  console.log(obj, obj.age) // {name: "wang"} 2


  Object.getOwnPropertyDescriptor(Object.prototype, '__proto__')
  // {enumerable: false, configurable: true, get: Æ’, set: Æ’}
  // å¯¹è±¡çš„ __proto__ å±æ€§ï¼Œæ˜¯ä» Object.prototype ä¸Šè·å–çš„ï¼Œå¹¶ä¸”æ˜¯è®¿é—®å™¨å±æ€§
```


ä¸ºå•¥è¦åˆ†æ•°æ®å±æ€§å’Œè®¿é—®å™¨å±æ€§å‘¢ï¼Ÿ  
ä»ä¸Šé¢æ‰“å°è¾“å‡ºçš„ç»“æœå¯ä»¥çª¥æ¢ä¸€äºŒï¼šæ•°æ®å±æ€§æ˜¯èƒ½æ‰“å°å‡ºæ¥çš„å€¼ï¼Œè€Œè®¿é—®å™¨å±æ€§æ˜¯éšè—çš„ï¼ˆå°±åƒ__proto__ä¸€æ ·ï¼‰ï¼ˆå°±åƒä¸€ä¸ªï¼Œä¸ï¼Œä¸€å¯¹å¹½çµä¸€æ ·ï¼Œèƒ½å­˜èƒ½å–ä½†å°±æ˜¯çœ‹ä¸åˆ°å®ƒï¼Œå­˜å–é€»è¾‘æœ‰å…³è”ä½†ä¸ä¸€æ ·ï¼‰
ç²—ç•¥ç†è§£ä¸ºï¼Œä¸€ä¸ªå®ä½“å±æ€§ï¼Œä¸€ä¸ªæ˜¯å¹½çµå±æ€§ï¼Œè¿™ä¸¤ç±»ã€‚  


ä¸ºä»€ä¹ˆéƒ½æœ‰ *configurable* å’Œ *enumerable* å±æ€§ï¼Ÿ  
è¿™ä¸ªé—®é¢˜éšå«çš„æ¡ä»¶æ˜¯åŒä¸€ä¸ªå±æ€§åï¼Œä¸€èˆ¬ï¼Œæˆ‘ä»¬ä¸ä¼šå®šä¹‰ä¸€ä¸ªå±æ€§ä¸€ä¼šæ˜¯å®ä½“å±æ€§ï¼Œä¸€ä¼šåˆæ˜¯å¹½çµå±æ€§ã€‚è™½ç„¶å±æ€§æœ‰ä¸¤ç§åˆ†ç±»ï¼Œä½†ä¸€ä¸ªå±æ€§åï¼ŒåŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªèº«ä»½ã€‚


## å®šä¹‰å±æ€§&è¯»å–å±æ€§  

ä¸Šè¿°çš„*Object.defineProperty()*æ–¹æ³•å¯ä»¥å®šä¹‰å•ä¸€å±æ€§ï¼Œæ‰¹æ“ä½œä¹Ÿæ˜¯å¯ä»¥æœ‰çš„ï¼Œé‚£å°±æ˜¯*Object.defineProperties()* æ–¹å¼ã€‚
```javascript
  var book = {}
  Object.defineProperties(book, {
    _year:{
      value: 2004
    },
    edition:{
      value: 1
    },
    year:{
      get(){
        return this._year
      },
      
      set(newValue){
        if(newValue > 2004){
          this._year = newValue
          this.edition= newValue - 2004;
        }
      }
    }
  })
```
çœ‹ç€è¿™ä¸ªä¾‹å­ï¼Œæ˜¯ä¸æ˜¯æœ‰ç‚¹åƒé—­åŒ…çš„åŠŸèƒ½äº†ã€‚*_year*å˜é‡ç†è§£ä¸ºå†…éƒ¨å˜é‡ï¼ˆè™½ç„¶å¤–éƒ¨èƒ½è®¿é—®åˆ°,ä½†ä¸å¯å˜writable=falseï¼Œä¸å¯éå†æšä¸¾enumeable=false,å†»ä½äº†configurable=falseï¼‰ï¼Œå­˜å–*year*å€¼éƒ½æ˜¯å¯¹æ­¤å€¼çš„æ“ä½œã€‚*year*åŒæ—¶ä¹Ÿåƒä»£ç†äººçš„æ„æ€ã€‚  


è¯»å–å±æ€§ï¼Œä½¿ç”¨ *Object.getOwnPropertyDescriptor()* æ–¹æ³•ã€‚
```javascript
  // è¯»å–ä¸Šä¾‹çš„book
  var descriptor = Object.getOwnPropertyDescriptor(book, '_year')
  alert(descriptor.value) // 2004
  alert(descriptor.configurable)  // false
  alert(typeof descriptor.get)  // undefined

  var descriptor = Object.getOwnPropertyDescriptor(book, 'year')
  alert(descriptor.value) // undefined
  alert(descriptor.configurable)  // false
  alert(typeof descriptor.get)  // function
```

## Proxy

*Proxy* ç¿»è¯‘è¿‡æ¥å°±æ˜¯ä»£ç†ï¼Œä½†æ˜¯ä»£ç†ä»€ä¹ˆå‘¢ï¼Ÿæ—¢ç„¶æ˜¯ç”¨åœ¨å¯¹è±¡ä¸Šï¼Œæ˜¯ä¸æ˜¯é¦–å…ˆæƒ³åˆ°çš„æ˜¯*get*/*set*,ç„¶åæ²¡æœ‰äº†ã€‚  
å¤šç•™äº›æ—¶é—´ç¢ç£¨ä¸‹ï¼Œè¿˜æœ‰ä»€ä¹ˆèƒ½ä»£ç†çš„ï¼Ÿå¯ä»¥å…ˆæƒ³æƒ³ä»€ä¹ˆæ˜¯å¯¹è±¡ã€‚  
JSä¸­ï¼Œé™¤äº†æ•£åˆ—é”®å€¼å¯¹ç»„æˆçš„é›†åˆï¼Œæ•°ç»„ã€å‡½æ•°ä¹Ÿéƒ½æ˜¯å¯¹è±¡ï¼ŒDateä¹Ÿæ˜¯ä¸€ç±»åŸç”Ÿå®ç°äº†çš„å¯¹è±¡ã€‚  

è™½ç„¶ä¹‹å‰çš„ESè§„èŒƒé‡Œæœ‰è®¿é—®å™¨å±æ€§ï¼Œå¯ä»¥ä½¿ç”¨ *set* *get* è‡ªå®šä¹‰æ“ä½œï¼Œä¹Ÿå¯ç§°ä¹‹ä¸ºèµ·äº†ä»£ç†ä½œç”¨ï¼Œä½†èŒƒå›´ä¹Ÿå°±åœ¨æŸä¸ªå±æ€§ä¸Šã€‚å¦‚æœè®©ä½ è®¾è®¡ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§ã€é€šç”¨çš„ä»£ç†å¯¹è±¡çš„æœºåˆ¶ï¼Œè¯¥æ€ä¹ˆåšï¼Ÿ  

æ‹ä¸€æ‹å¯¹è±¡æœ‰å“ªäº›æ“ä½œï¼Œå“ªäº›ç‰¹å¾ï¼Ÿ   
1. å­˜å–å€¼ï¼Œä½¿ç”¨ *.* æ“ä½œç¬¦ æˆ– *[ ]* æ¥è·å– *get* *set*
2. ç»§æ‰¿å…³ç³»ï¼Œç›¸å…³æ“ä½œ *instanceof* *\_\_proto\_\_* 
3. éå†æ“ä½œ *for...in...*
4. åˆ¤æ–­keyæ˜¯å¦å­˜åœ¨ *in*
5. æ•°æ®å±æ€§å’Œè®¿é—®å™¨å±æ€§æ“ä½œ *Object.defineProperty* *Object.defineProperties* 
6. å‡½æ•°çš„è¯ï¼Œè°ƒç”¨æ‰§è¡Œæ“ä½œ
7. æ„é€ å‡½æ•°çš„è¯ï¼Œ*new* æ“ä½œ
8. è°ƒç”¨æ–¹æ³•æ—¶ *this* æŒ‡å‘é—®é¢˜  
...

æ—¢ç„¶è¦è®¾è®¡ä»£ç†ï¼Œä¸å¦¨æŠŠè¿™äº›ç‰¹æ€§ä¸€ç½‘æ‰“å°½ã€‚ä¹‹å‰çš„è®¿é—®å™¨å±æ€§è¿˜æ˜¯å¤ªå°æ°”ï¼Œä¸€æ¬¡åªèƒ½è®¾ç½®ä¸€ä¸ªå±æ€§ã€‚æˆ‘ä»¬å¤§æ–¹ç‚¹ï¼Œè®¾è®¡åŒ¹é…é€šç”¨å±æ€§çš„æ–¹å¼ï¼Œå°±ä¸èƒ½æŠŠ*key*ä½œä¸ºå‚æ•°ã€‚  
è€ƒè™‘ä¸‹è¿”å›å€¼ï¼Œä»£ç†åçš„å¯¹è±¡æ˜¯ä»€ä¹ˆï¼Ÿåœ¨åŸå€¼ä¸Šæ“ä½œï¼Ÿè‚¯å®šä¸è¡Œï¼Œè¿åè®¾è®¡åŸåˆ™ï¼Œæœ€å¥½æ¥ä¸ªåˆ†èº«ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªæ–°çš„å¯¹è±¡ã€‚å°±å¥½åƒä½ åˆ«å¢…é‡Œçš„ç®¡å®¶ä¸€æ ·ï¼Œç®¡å®¶æŒ‰ç…§ä½ çš„æˆæƒï¼Œå¸®ä½ å®Œæˆå’Œç¤¾ä¼šçš„å¿…è¦äº¤æµã€‚å…³é”®æ˜¯æˆæƒï¼Œå“ªäº›äº‹æƒ…ç®¡å®¶è‡ªå·±åšï¼Œå“ªäº›äº‹æƒ…ä¾ç„¶è½åˆ°ä½ èº«ä¸Šã€‚
ä½ å¯ä»¥æœ‰å¤šä¸ªç®¡å®¶ï¼Œåˆ›å»ºçš„è¿‡ç¨‹ä½¿ç”¨æ„é€ å‡½æ•°å†åˆé€‚ä¸è¿‡äº†ã€‚  

### å€¼çš„å­˜å– set get

äºæ˜¯è¿™æ ·å¦‚ä½•ï¼š
```javascript
  const yourSelf = {name:'Li Lei'}
  const agentConfig = {
    get(host, order){
      return host[order]
    },
    set(host, order, val){
      host[order] = val
    }
  }
  const agent = new Proxy(yourSelf, agentConfig) // targetæ˜¯è¦ä»£ç†çš„å¯¹è±¡ 

  console.log(agent.name) // Li Lei
  agent.name = "Xiao hong"
  console.log(agent.name) // Xiao hong
  console.log(agent.age) // undefined
```

æ—¢ç„¶æ˜¯åŸç”Ÿçš„æ„é€ å‡½æ•°ï¼Œ*Proxy*æƒ³å½“ç„¶åº”è¯¥æ˜¯ç»§æ‰¿è‡ª *Object*
```javascript
console.log(Proxy.prototype) // undefined
console.log(Proxy instanceof Object) // true
console.log(age.__proto__ == Object.prototype) // true
```
*Proxy.prototype* å€¼ç«Ÿç„¶æ˜¯ *undefined*,ğŸ˜¯ï¼ï¼ï¼çœ‹æ¥å¾—å•ç‹¬ä¸€ç¯‡å†™ç»§æ‰¿é—®é¢˜äº†  

ä¸“ä¸šä¸€ç‚¹ï¼ŒæŠŠ *order* å«åš *propKey* ,æŠŠ *agentConfig* å«åš *handler* 

```javascript
  const book = {name:'çº¢å®ä¹¦'}
  const handler = {
    get(target, propKey){
      return target[propKey]
    }
  }
  const proxy = new Proxy(book, handler)
```
æ ‡å‡†é‡Œï¼Œ*set* *get* è¿˜æœ‰æœ€åä¸€ä¸ªå‚æ•° *receiver* ,æŒ‡ä»£å®ä¾‹æœ¬èº«ã€‚å®ä¾‹ä¹Ÿæ˜¯å¯¹è±¡ï¼Œè¿™ä¸ªå‚æ•°å°±æ˜¯ä¸ªæŒ‡å‘å †ç©ºé—´çš„ä¸€ä¸ªåœ°å€ã€‚æˆ‘æƒ³åœ¨åˆ¶é€  *å¾ªç¯å¼•ç”¨* *é€’å½’* æ–¹é¢æœ‰ç”¨å¤„ã€‚


åŠ«æŒäº† *get* *set* æ¥åšä»€ä¹ˆå‘¢ï¼Œè¯´ä¸ªåº”ç”¨ï¼Œæ¯”å¦‚è®© *get* è¿”å›ä¸€ä¸ªå‡½æ•°çš„åœºæ™¯ï¼š

```javascript
  var dom = new Proxy({}, {
    get(target, propKey, receiver){
      return function(attrs = {}, ...children){
        var ele = document.createElement(propKey)
        Object.keys(attrs).forEach(attrName=>{
          ele.setAttribute(attrName, attrs[attrName])
        })
        children.forEach(child =>{
          if(typeof child === 'string'){
            var text = document.createTextNode(child)
            ele.appendChild(text)
          }else{
            ele.appendChild(child)
          }

        })
        return ele
      }
    }
  })
  var fragment = dom.div(
      {id:'container'},
      'è¿™é‡Œæ˜¯container',
      dom.ul({},
        dom.li({class:'li'}, 'li1'),
        dom.li({class:'li'}, 'li2'),
        dom.li({class:'li'}, 'li3'),
      )
    )
  console.log(fragment)
```
è¿™æ ·åˆ›å»ºå‡ºæ¥çš„æ ‘çŠ¶ç»“æ„çš„ DOM èŠ‚ç‚¹ï¼Œç®€å•æ˜äº†ï¼Œæ ¸å¿ƒæ˜¯ç”¨äº† *Proxy* åŠ«æŒä»»æ„å±æ€§ï¼Œå¹¶è¿”å›ä»»æ„æ ¼å¼æ•°æ®ï¼ˆè¿™é‡Œè¿”å›ä¸€ä¸ªåˆ›å»ºDOMçš„å‡½æ•°ï¼‰  

å†ä¸¾ä¾‹ï¼Œä¸€ä¸ªé“¾å¼æ“ä½œï¼š
```javascript
  var pipe = function(value){
    var quene = []
    return new Proxy({}, {
      get(target, propKey, receiver){
        if(propKey !== 'get'){
          quene.push(window[propKey])
          return receiver
        }else{
          return quene.reduce((acc, cur) =>{
            return cur(acc)
          }, value)
        }

      }

    })
  }
  var double = n => n * 2;
  var pow = n => n * n;
  pipe(3).double.pow.get;
```

æ ¸å¿ƒå‘¢ï¼Œä½¿ç”¨äº†*é—­åŒ…*ã€return *receiver* ã€ä»»æ„å±æ€§åŠ«æŒ å®ç°é“¾å¼æ“ä½œï¼ŒæŒºå·§å¦™çš„æ–¹å¼ï¼Œçœ‹åˆ°è¿™é‡Œæ˜¯ä¸æ˜¯è”æƒ³åˆ°ç§‘é‡ŒåŒ–çš„æ¨¡å¼ã€‚  

åœ¨ *get* *set* æ—¶å€™ï¼Œä¹Ÿä¸æ˜¯ä»»æ„å±æ€§éƒ½èƒ½åŠ«æŒæˆåŠŸï¼Œå¦‚æœä¸€ä¸ªå±æ€§æ˜¯ä¸å¯ *configurable* ä¸” ä¸å¯ *writeable* çš„ï¼Œå°±ä¼šå¤±è´¥ã€‚æ²¡åŠæ³•ï¼Œä»–ä¸¤å…·æœ‰ç»å¯¹çš„ä¼˜å…ˆåˆ¤æ–­æƒã€‚

å¯¹äº *set* çš„åŠ«æŒå¯ä»¥åšä¸€äº›ä»€ä¹ˆäº‹æƒ…å‘¢ï¼Ÿèƒ½æƒ³è±¡åˆ°çš„åœºæ™¯æœ‰   
1. å¯ä»¥å°è£…å€¼çš„å¤æ‚æ ¡éªŒ  
2. å¯ä»¥çœŸæ­£åšåˆ°å±æ€§ä¿æŠ¤ï¼Œå› ä¸ºå±æ€§æ˜¯ä½œä¸ºå‚æ•°ä¼ é€’è¿‡æ¥çš„ï¼Œé€»è¾‘å¯ä»¥è‡ªå®šä¹‰  

ä¾‹å­å°±ä¸ä¸¾äº†ã€‚


### å‡½æ•°åŠ«æŒ apply

åŠ«æŒå‡½æ•°åˆ°åº•èƒ½è¾¾åˆ°ä¸€ä¸ªä»€ä¹ˆæ•ˆæœå‘¢ï¼Ÿä¼ å…¥ä¸€ä¸ªå‡½æ•°ï¼Œç»è¿‡ä»£ç†åï¼ŒåŠ ä¸Šè‡ªå®šä¹‰é€»è¾‘ï¼Œè¿”å›ä¸€ä¸ªæ–°çš„å‡½æ•°ã€‚

```javascript
  var handler = {
    apply(target, ctx, args){
      console.log(ctx, args, this)
      return target.apply(ctx, args)
    }
  }
  function add(a, b){return a + b}
  var proxy = new Proxy(add, handler)
  proxy(1,2) // 3
  proxy.call({s:0}, 2, 3) // 5
```
å‡½æ•°çš„æ‰§è¡Œï¼Œæœ‰ä¸€ä¸ªä¸Šä¸‹æ–‡å¯¹è±¡çš„æ¦‚å¿µï¼Œç›¸å½“äºä¸€ä¸ªå¯¹å‡½æ•°çš„ä¸€ä¸ªæ‰©å±•å§ï¼Œå¯ä»¥åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä»ä¸Šä¸‹æ–‡å¯¹è±¡é‡Œæ‹¿åˆ°ä¸°å¯Œçš„apiã€‚å•çº¯åœ°å‡½æ•°æ‰§è¡Œè¯¥æ˜¯å¤šä¹ˆåœ°å•è°ƒï¼Œè€Œå¦‚æœç›´æ¥æ‹¿å˜é‡åç§°åˆæ˜¾å¾—è€¦åˆæ€§å¤ªå¼ºï¼Œäºæ˜¯æœ‰äº†ä¸Šä¸‹æ–‡å¯¹è±¡çš„éšå¼è°ƒç”¨ï¼Œå¾ˆå·§å¦™çš„æ–¹å¼å‘ã€‚*apply* çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œä¸“é—¨å°±ç»™è¿™ä¸Šä¸‹æ–‡ç•™ä¸‹çš„ã€‚ç¬¬ä¸‰ä¸ªå‚æ•°ç”¨æ¥æ¥æ”¶ä¼ æ¥çš„å‚æ•°ã€‚  

è¿˜æ˜¯ç›¸å½“äºç»™å‡½æ•°åšäº†ä¸€å±‚ä»£ç†ï¼Œå®é™…ç”¨å¤„æš‚ä¸”æ²¡æƒ³åˆ°å¥½çš„åœºæ™¯ã€‚

### å±æ€§å­˜åœ¨ä¸å¦ has

*has* æ˜¯åˆ¤æ–­å±æ€§æ˜¯å¦å­˜åœ¨ï¼Œå¯¹åº”çš„æ“ä½œç¬¦æ˜¯ *in* ã€‚å®¹æ˜“å’Œæšä¸¾ææ··ï¼Œå¯¹åº”çš„æ˜¯ *for...in...* ã€‚ æ­¤ *in* éå½¼ *in* ã€‚  
è®¿é—®ä»£ç†å¯¹è±¡ï¼Œæˆ–è€…å…¶åŸå‹é“¾ä¸Šçš„å±æ€§ï¼Œéƒ½ä¼šèµ°*has*ã€‚  
å¦‚æœä½¿ç”¨äº† *Object.preventExtensions* æ¥é”ä½å¯¹è±¡ï¼Œæ­¤æ—¶å†ç”¨ *has* è¿”å› *false* å°±ä¼šæŠ¥é”™ã€‚å¯¹è±¡è¢«é”ä½ï¼Œå±æ€§ä¸å¯é…ç½®ï¼Œä»£ç†å°±ä¸èƒ½éšè—è¯¥å±æ€§ã€‚  

```javascript
  const book = {
    name:'çº¢å®ä¹¦',
    _edition: 4
  }
  Object.setPrototypeOf(book, {publisher:"äººæ•™å‡ºç‰ˆç¤¾"})
  const handler = {
    has(target, propKey){
      console.log('propKey--', propKey)
      if(propKey.startsWith('_')){
        return false
      }
      return true
    }
  }
  const proxy = new Proxy(book, handler)
  console.log('name' in proxy) // true
  console.log('_edition' in proxy) // false
  console.log('publisher' in proxy) // false
  for (let key in proxy){
    console.log(key) // name _edition
  }
```

### æ„é€ å‡½æ•°çš„æ‹¦æˆª construct

```javascript
  var Book = function(name){
    this.name = name
  }
  var handler = {
    construct(target, args, newTarget){
      return new target(...args)
    }
  }
  var Cons = new Proxy(Book, handler)
  var book = new Cons('ç»¿çš®ä¹¦')
  console.log(book, book instanceof Cons, book instanceof Book) // BookÂ {name: "ç»¿çš®ä¹¦"} true true
```

ä½¿ç”¨ *construct* ï¼ˆç¿»è¯‘ï¼šå»ºé€ ï¼‰å‡½æ•°æ¥åŠ«æŒï¼Œå‚æ•°æœ‰ åŸæ„é€ å‡½æ•°ã€ä¼ å…¥å‚æ•°ã€ä»¥åŠå’Œ*get* *set* ç›¸åŒçš„å®ä¾‹å¯¹è±¡æœ¬èº«ã€‚ä¹Ÿå°±æ˜¯ç›¸å½“äºåŸå‹é“¾ä¸ŠåŠ äº†ä¸ªçˆ¶å¯¹è±¡ã€‚


### åˆ é™¤çš„æ‹¦æˆª deleteProperty

å¯¹è±¡å±æ€§å¯ä»¥åˆ é™¤ï¼Œä½¿ç”¨ *delete* æ“ä½œç¬¦ã€‚å¦‚æœè®¾ç½®äº† *configurable* ä¸º *false* åˆ™ä¼šæŠ¥é”™ã€‚  

```javascript
  var handler = {
    deleteProperty(target, key){
      if(key[0] === '_'){
        throw new Error(`invalid attempt to delete private ${key} property`)
      }
      delete target[key]
      return true
    }
  }
```

### å®šä¹‰å±æ€§æ“ä½œçš„æ‹¦æˆª defineProperty 

è™½ç„¶ä¹‹å‰å®šä¹‰å±æ€§çš„æ–¹æ³•æ˜¯ *Object.defineProperty()* ï¼Œåœ¨*Object*åŸå‹ä¸Šï¼Œçœ‹ä¼¼å…³ç³»è¿œäº†ã€‚ä½†æ˜¯è°è®©ä½ è¦æ“ä½œã€æ”¹å˜å¯¹è±¡å‘¢ï¼Œä½œä¸ºåŠŸèƒ½å…¨é¢çš„ä»£ç†å°±æœ‰ä¹‰åŠ¡æ‹¦æˆªä¸‹æ¥ã€‚  
```javascript
  var handler = {
    defineProperty(target, key, descriptor){
      return false
    }
  }
  var book = {name:'çº¢å®ä¹¦'}
  var copyBook = new Proxy(book, handler)
  Object.defineProperty(copyBook, 'name', {
    value: 'è´è¶ä¹¦'
  })
  copyBook.a = 'foo' // ä¸ç”Ÿæ•ˆ
```

### è·å–å±æ€§æè¿°ç¬¦çš„æ‹¦æˆª getOwnPropertyDescriptor

*Object.getOwnPropertyDescriptor(target, key)* å¯è·å–å±æ€§çš„æè¿°ç¬¦ï¼Œå¯¹æ­¤åšæ‹¦æˆªã€‚
```javascript
  var handler = {
    getOwnPropertyDescriptor(target, key){
      return Object.getOwnPropertyDescriptor(target, key)
    }
  }
  var book = {name:'çº¢å®ä¹¦'}
  var copyBook = new Proxy(book, handler)
  Object.getOwnPropertyDescriptor(copyBook, 'name')
```

### è·å–åŸå‹å¯¹è±¡çš„åŠ«æŒ getPrototypeOf

è·å–åŸå‹å¯¹è±¡ï¼Œå¯¹åº”ä¸€äº›æ“ä½œç¬¦æˆ–æ–¹æ³•æˆ–å±æ€§ã€‚  
- Object.prototype.\_\_proto\_\_ ï¼ˆ\_\_proto\_\_ æ˜¯ä¸ªè®¿é—®å™¨å±æ€§ï¼‰
- Object.getPrototypeOf()
- Object.isPrototypeOf()
- instanceof

```javascript
  var proto = {name: 'äººæ•™'}
  var handler = {
    getPrototypeOf(target){
      return proto
    }
  }
  var book = {}
  var copyBook = new Proxy(book, handler)
  Object.getPrototypeOf(copyBook) === proto // true
```

### å¯¹è±¡æ‰©å±•åˆ¤æ–­çš„æ‹¦æˆª isExtensible

*Object.isExtensible* å®šä¹‰å½“å‰æ˜¯å¦å¯ä»¥æ‰©å±•ï¼Œå¯¹æ­¤è¿›è¡Œæ‹¦æˆªã€‚
```javascript
  var ins = new Proxy({}, {
    isExtensible(target){
      console.log('in')
      return true
    }
  })
  Object.isExtensible(ins) // in
  // Object.freeze(ins)
  // Object.seal(ins)
```
è¿”å›å€¼æ˜¯ *boolean* ç±»å‹ã€‚è¿™é‡Œæœ‰ä¸ªé™åˆ¶ï¼Œå°±æ˜¯å¿…é¡»å’Œæºå¯¹è±¡çš„ *isExtensible* è¿”å›å€¼ä¸€è‡´ã€‚ä»£ç†çš„åŠŸèƒ½åœ¨è¿™é‡Œæ‰“äº†æŠ˜æ‰£ã€‚ä¸ç„¶ä¼šæŠ¥é”™ã€‚


### è‡ªèº«æ‰€æœ‰å±æ€§è¯»å– ownKeys

æ‹¦æˆªå¯¹è±¡è‡ªèº«å±æ€§è¯»å–ï¼Œå…·ä½“æ¥é¦–ï¼Œæ‹¦æˆªä¸€ä¸‹æ“ä½œï¼š   
- Object.getOwnPropertyNames()
- Object.getOwnPropertySymbols()
- Object.keys()
- for...in...  

```javascript
  var target = {
    a: 1,
    b: 2,
    [Symbol.for('secret')]: 3,
  }
  Object.defineProperty(target, 'defi', {
    enumerable: false,
    value: 'static'
  })
  var handler = {
    ownKeys(target){
      return ['a', 'c', Symbol.for('secret'), 'defi']
    }
  }
  var proxy = new Proxy(target,handler)
  Object.keys(proxy) // ['a']
```
å¯¹äºè‡ªèº«å±æ€§çš„è¯»å–çš„æ‹¦æˆªï¼Œä¹Ÿä¸æ˜¯éšæ„çš„ï¼ŒéåŸå¯¹è±¡ä¸Šçš„å±æ€§å°±ä¼šè¢«è¿‡æ»¤ï¼ŒåŒæ—¶ Symbol å€¼ ä»¥åŠä¸å¯éå†çš„å±æ€§ï¼Œéƒ½ä¼šè¢«è‡ªåŠ¨è¿‡æ»¤ã€‚  
å¦å¤–ï¼Œå¦‚æœå¯¹è±¡æ˜¯è¢«ç½®ä¸ºä¸å¯æ‰©å±•çš„ï¼Œè¿”å›äº†å¤šä½™çš„å€¼ï¼Œåˆ™ä¼šæŠ¥é”™ã€‚  

### é˜»æ­¢å±æ€§æ‰©å±•çš„æ‹¦æˆª preventExtensions

æƒ³è¦é˜»æ­¢æ‰©å±•ï¼Œé¦–å…ˆå°±å¾—æ˜¯ä¸€ä¸ªå¯æ‰©å±•çš„ *Object.isExtensible* ä¸º *true* ã€‚ä»£ç†è¿™ä¸ªå±æ€§ï¼Œè¿”å›å€¼æ˜¯ *boolean* ,è¯­æ„ä¸Šè¿˜å¾—è¿‡å¾—å»ï¼Œæ¯”å¦‚æºå¯¹è±¡æœ¬æ¥æ˜¯ä¸å¯æ‰©å±•çš„ï¼Œä»£ç†åå˜æˆå¯ä»¥æ‰©å±•çš„ï¼Œé‚£å°±ä¼šæŠ¥é”™ã€‚

```javascript
var proxy = new Proxy({}, {
  preventExtensions(target){

    // do somethings 
    Object.preventExtensions(target)
    return true
  }
})
Object.preventExtensions(proxy)
```

éœ€è¦åœ¨å‡½æ•°å†…å®ç°çœŸå®çš„ *Object.preventExtensions(target)* å¹¶ä¸” *return true*ï¼Œè¿™æ ·æ‰ä¸ä¼šæŠ¥é”™ã€‚


### è®¾ç½®åŸå‹å¯¹è±¡çš„æ‹¦æˆª  setPropertyOf

å¦‚æœå¯¹è±¡ä¸å¯æ‰©å±•ï¼Œåˆ™æ”¹å˜ä¸äº†åŸå‹ã€‚

```javascript
  var handler = {
    setPrototypeOf(target, proto){
      // do somethins
      Object.setPrototypeOf(target, proto)
    }
  }
  var book = {}
  var proxy = new Proxy(book, handler)
  Object.setPrototypeOf(proxy, {name: 'çº¢å®ä¹¦'})
```

### ä¸€ä¸ªå¯å–æ¶ˆçš„å®ä¾‹ Proxy.revocable

```javascript
  var target = {}
  let handler = {}

  let {proxy, revoke} = Proxy.revocable(target, handler)

  proxy.foo = 1
  proxy.foo // 1
  revoke()
  proxy.foo   // TypeError: Revoked
```
è¢« *revoke* çš„å®ä¾‹ï¼Œä¸èƒ½è®¿é—®å±æ€§ã€‚åœºæ™¯å¯ä»¥æ˜¯å•æ¬¡è®¿é—®æœ‰æ•ˆã€‚

### this é—®é¢˜

Proxy ä»£ç†å‡½æ•°å†…çš„ *this* æ˜¯å®ä¾‹ï¼ˆ*proxy*ï¼‰æœ¬èº«ï¼Œå¯èƒ½åœ¨ *target* æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œä¼šéœ€è¦ *this* ç»‘å®šåˆ°å½“å‰å¯¹è±¡ä¸Šï¼Œéœ€è¦æ”¹å˜ *this*ã€‚

```javascript
  var target = new Date('2020-01-02')
  var handler = {
    get(target, propKey){
      if(propKey === 'getDate'){
        return target.getDate.bind(target)
      }
      return Reflect.get(target, propKey)
    }
  }
```

### ä¸€ä¸ªä½¿ç”¨ä»£ç†ç®€åŒ–è¯·æ±‚çš„ä¾‹å­

```javascript
  function createServer(baseUrl){
    return new Proxy({}, {
      get(target, prop){
        return async ()=> fetch(baseUrl + prop)
      }
    })
  }
  var request = createServer('http://localhost:8080/')
  request.user().then(data => {
    console.log(data)
  })
```






å‚è€ƒï¼š
1. [JavaScript é«˜çº§ç¨‹åºè®¾è®¡](https://book.douban.com/subject/1869705/)
2. [ECMAScript 6 å…¥é—¨](https://es6.ruanyifeng.com/#docs/proxy)





